<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding and viewport settings for responsiveness -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Title of the page displayed on the browser tab -->
    <title>Product Details</title>
    
    <!-- Link to the stylesheet for the product page styling -->
    <link rel="stylesheet" href="/styles/product.css">
    
    <!-- Link to the favicon for the browser tab -->
    <link rel="icon" href="/images/dollar.jpg" type="image/x-icon">
    
    <!-- Link to Chart.js for rendering charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Navigation bar with links to different sections of the site -->
    <nav class="navbar">
        <ul class="navbar-links">
            <li><img src="/images/pricewatchlogo.png" alt="PriceWatch Logo"></li>
            <li><a href="/">Home</a></li>
            <li><a href="/tracked">Tracked Products</a></li>
            <li><a href="/about">About PriceWatch</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Container for the product details -->
        <div class="product-container">
            <!-- Section displaying the product image -->
            <div class="product-image">
                <img src="<%= product.imageUrl %>" alt="<%= product.title %>">
            </div>
            
            <!-- Section displaying detailed information about the product -->
            <div class="product-details">
                <h1 class="product-title"><%= product.title %></h1>
                
                <!-- Conditional rendering based on the store -->
                <% if (product.store === 'Amazon') { %>
                    <div class="price-box">
                        <img src="/images/amazon.png" alt="Amazon Logo" class="store-logo"> Amazon Price: <%= product.price %>
                    </div>
                    <div class="price-box">
                        <img src="/images/prime.png" alt="Amazon Logo" class="store-logo"> Prime Price: <%= product.primePrice %>
                    </div>
                <% } else if (product.store === 'Best Buy') { %>
                    <div class="price-box">
                        <img src="/images/bestbuy.png" alt="Best Buy Logo" class="store-logo"> Best Buy Price: <%= product.price %>
                    </div>
                <% } else if (product.store === 'Nike') { %>
                    <div class="price-box">
                        <img src="/images/nike.png" alt="Nike Logo" class="store-logo"> Nike Price: <%= product.price %>
                    </div>
                <% } else if (product.store === 'Home Depot') { %>
                    <div class="price-box">
                        <img src="/images/homedepot.png" alt="Home Depot Logo" class="store-logo"> Home Depot Price: <%= product.price %>
                    </div>
                <% } else if (product.store === 'Walgreens') { %>
                    <div class="price-box">
                        <img src="/images/walgreens.png" alt="Walgreens Logo" class="store-logo"> Walgreens Price: <%= product.price %>
                    </div>
                <% } else if (product.store === 'Sams Club') { %>
                    <div class="price-box">
                        <img src="/images/samsclub.png" alt="Sams Club Logo" class="store-logo"> Sam's Club Price: <%= product.price %>
                    </div>
                <% } %>
                
                <!-- Display prices for other stores associated with the product -->
                <% product.stores.forEach(store => { %>
                    <% if (store.store === 'Amazon') { %>
                        <div class="price-box">
                            <img src="/images/amazon.png" alt="Amazon Logo" class="store-logo"> Amazon Price: <%= store.price %>
                        </div>
                        <div class="price-box">
                            <img src="/images/prime.png" alt="Amazon Logo" class="store-logo"> Prime Price: <%= store.primePrice %>
                        </div>
                    <% } else if (store.store === 'Best Buy') { %>
                        <div class="price-box">
                            <img src="/images/bestbuy.png" alt="Best Buy Logo" class="store-logo"> Best Buy Price: <%= store.price %>
                        </div>
                    <% } else if (store.store === 'Nike') { %>
                        <div class="price-box">
                            <img src="/images/nike.png" alt="Nike Logo" class="store-logo"> Nike Price: <%= store.price %>
                        </div>
                    <% } else if (store.store === 'Home Depot') { %>
                        <div class="price-box">
                            <img src="/images/homedepot.png" alt="Home Depot Logo" class="store-logo"> Home Depot Price: <%= store.price %>
                        </div>
                    <% } else if (store.store === 'Walgreens') { %>
                        <div class="price-box">
                            <img src="/images/walgreens.png" alt="Walgreens Logo" class="store-logo"> Walgreens Price: <%= store.price %>
                        </div>
                    <% } else if (store.store === 'Sams Club') { %>
                        <div class="price-box">
                            <img src="/images/samsclub.png" alt="Sams Club Logo" class="store-logo"> Sam's Club Price: <%= store.price %>
                        </div>
                    <% } %>
                <% }); %>
                
                <!-- Buttons to buy the product or add a new store -->
                <div class="buy-now-button-container">
                    <a href="<%= product.url %>" target="_blank" class="buy-now-button">Buy on <%= product.store %></a>
                    <% product.stores.forEach(store => { %>
                        <a href="<%= store.url %>" target="_blank" class="buy-now-button">Buy on <%= store.store %></a>
                    <% }); %>
                </div>
                <button id="addStoreButton">Add Store</button>
                
                <!-- Form to add a new store URL, initially hidden -->
                <form id="storeUrlForm" action="/products/add-store-url/<%= productIndex %>" method="post" style="display:none;" onsubmit="showLoadingPopup()">
                    <input type="text" name="storeUrl" placeholder="Enter Product URL" required>
                    <button type="submit">Add URL</button>
                </form>
            </div>
        </div>
        
        <!-- Section displaying the price history with a chart -->
        <div class="price-history">
            <h2>Price History</h2>
            <p>Last Updated: <%= product.lastUpdated %></p>
            <ul>
                <% product.history.forEach(entry => { %>
                    <li>Time: <%= entry.time %>, 
                    <% if (entry.store === 'Amazon') { %>
                        Amazon Price: <%= entry.price %>, Prime Price: <%= entry.primePrice %>
                    <% } else if (entry.store === 'Best Buy') { %>
                        Best Buy Price: <%= entry.price %>
                    <% } else if (entry.store === 'Nike') { %>
                        Nike Price: <%= entry.price %>
                    <% } else if (entry.store === 'Home Depot') { %>
                        Home Depot Price: <%= entry.price %>
                    <% } else if (entry.store === 'Walgreens') { %>
                        Walgreens Price: <%= entry.price %>
                    <% } else if (entry.store === 'Sams Club') { %>
                        Sam's Club Price: <%= entry.price %>
                    <% } %>
                    </li>
                <% }) %>
            </ul>
            <!-- Canvas element for rendering the price history chart -->
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    
    <!-- Loading Overlay and Popup -->
    <div id="loadingOverlay" class="loading-overlay"></div>
    <div id="loadingPopup" class="loading-popup">
        <div class="lds-dual-ring"></div>
        <p>Fetching Product Information...</p>
    </div>

    <script>
        // Toggle the visibility of the "Add Store" form
        document.getElementById('addStoreButton').addEventListener('click', function() {
            const form = document.getElementById('storeUrlForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });

        // On document load, check for error messages and render the price chart
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const errorMessage = params.get('error');
            if (errorMessage) {
                alert(decodeURIComponent(errorMessage)); // Display error as alert
            }
            renderPriceChart();

            // Function to render the price chart using Chart.js
            function renderPriceChart() {
                const ctx = document.getElementById('priceChart').getContext('2d');
                const times = <%- JSON.stringify(product.history.map(entry => entry.time)) %>;
                const amazonPrices = <%- JSON.stringify(product.history.filter(entry => entry.store === 'Amazon').map(entry => ({ x: entry.time, y: parseFloat(entry.price.replace(/[^0-9.-]+/g,""))
